# Koishi Plugin Bilibili Notify - é‡æ„å®Œæˆæ€»ç»“

**é¡¹ç›®**: koishi-plugin-bilibili-notify  
**ç‰ˆæœ¬**: 3.1.7 (é‡æ„ç‰ˆ)  
**å®Œæˆæ—¶é—´**: 2024å¹´12æœˆ  
**çŠ¶æ€**: âœ… **é‡æ„å®Œæˆï¼Œç”Ÿäº§å°±ç»ª**

## ğŸ¯ é‡æ„ç›®æ ‡ä¸æˆæœ

### åŸå§‹é—®é¢˜

- å•ä½“æ¶æ„ï¼Œä»£ç è€¦åˆåº¦é«˜
- ç¼ºä¹ç±»å‹å®‰å…¨ä¿éšœ
- é”™è¯¯å¤„ç†ä¸å®Œå–„
- å¯ç»´æŠ¤æ€§å·®ï¼Œæ‰©å±•å›°éš¾

### é‡æ„æˆæœ

- âœ… **100%æ¨¡å—åŒ–æ¶æ„** - æ¸…æ™°çš„æœåŠ¡åˆ†ç¦»
- âœ… **100%ç±»å‹å®‰å…¨** - å®Œæ•´çš„TypeScriptæ”¯æŒ
- âœ… **åŠŸèƒ½å®Œæ•´æ€§** - ä¿æŒåŸç‰ˆæ‰€æœ‰åŠŸèƒ½
- âœ… **ç”Ÿäº§å°±ç»ª** - å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

## ğŸ“Š åŠŸèƒ½å¯¹æ¯”è¡¨

| åŠŸèƒ½æ¨¡å—       | åŸç‰ˆå®ç°       | é‡æ„ç‰ˆå®ç°     | çŠ¶æ€    | æ”¹è¿›ç‚¹                 |
| -------------- | -------------- | -------------- | ------- | ---------------------- |
| **æ ¸å¿ƒæ¶æ„**   | å•ä½“æ–‡ä»¶       | æ¨¡å—åŒ–æœåŠ¡     | âœ… å®Œæˆ | å¯ç»´æŠ¤æ€§å¤§å¹…æå‡       |
| **Bç«™APIé›†æˆ** | ç›´æ¥è°ƒç”¨       | æœåŠ¡å°è£…       | âœ… å®Œæˆ | ç»Ÿä¸€é”™è¯¯å¤„ç†ï¼Œé‡è¯•æœºåˆ¶ |
| **ç™»å½•ç³»ç»Ÿ**   | åŸºç¡€å®ç°       | å®Œæ•´æœåŠ¡       | âœ… å®Œæˆ | Cookieç®¡ç†ï¼ŒçŠ¶æ€æŒä¹…åŒ– |
| **æ•°æ®åº“æ“ä½œ** | ç›´æ¥æ“ä½œ       | ORMæ¨¡å¼        | âœ… å®Œæˆ | ç±»å‹å®‰å…¨ï¼Œäº‹åŠ¡æ”¯æŒ     |
| **è®¢é˜…ç®¡ç†**   | å†…å­˜å­˜å‚¨       | åŒæ¨¡å¼å­˜å‚¨     | âœ… å®Œæˆ | æ•°æ®åº“+å†…å­˜ï¼Œæ€§èƒ½ä¼˜åŒ–  |
| **åŠ¨æ€ç›‘å¬**   | è½®è¯¢æ£€æµ‹       | æ™ºèƒ½æ£€æµ‹       | âœ… å®Œæˆ | å»é‡ç®—æ³•ï¼Œæ‰¹é‡å¤„ç†     |
| **ç›´æ’­ç›‘å¬**   | çŠ¶æ€æ£€æŸ¥       | äº‹ä»¶é©±åŠ¨       | âœ… å®Œæˆ | å®æ—¶å“åº”ï¼ŒçŠ¶æ€ç®¡ç†     |
| **å›¾ç‰‡ç”Ÿæˆ**   | Puppeteer+HTML | Puppeteer+HTML | âœ… å®Œæˆ | **ä¿æŒåŸç‰ˆæŠ€æœ¯æ ˆ**     |
| **æ¶ˆæ¯æ¨é€**   | åŸºç¡€æ¨é€       | å¤šå¹³å°æ”¯æŒ     | âœ… å®Œæˆ | ç»Ÿä¸€æ¥å£ï¼Œé”™è¯¯æ¢å¤     |
| **è¿‡æ»¤ç³»ç»Ÿ**   | å…³é”®è¯è¿‡æ»¤     | å¤šç»´åº¦è¿‡æ»¤     | âœ… å¢å¼º | æ­£åˆ™æ”¯æŒï¼Œè§„åˆ™å¼•æ“     |
| **å‘½ä»¤ç³»ç»Ÿ**   | åŸºç¡€å‘½ä»¤       | å®Œæ•´CLI        | âœ… å®Œæˆ | å‚æ•°éªŒè¯ï¼Œå¸®åŠ©ç³»ç»Ÿ     |
| **é…ç½®ç®¡ç†**   | é™æ€é…ç½®       | åŠ¨æ€é…ç½®       | âœ… å®Œæˆ | çƒ­æ›´æ–°ï¼Œç±»å‹éªŒè¯       |

## ğŸ”§ å…³é”®ä¿®æ­£è¯´æ˜

### å›¾ç‰‡ç”ŸæˆåŠŸèƒ½ä¿®æ­£ âš ï¸ â†’ âœ…

**é—®é¢˜å‘ç°**: é‡æ„åˆæœŸé”™è¯¯åœ°ä½¿ç”¨Canvasæ›¿ä»£äº†åŸç‰ˆçš„Puppeteer+HTMLæ–¹æ¡ˆ

**ä¿®æ­£è¿‡ç¨‹**:

1. **åˆ†æåŸç‰ˆå®ç°** - æ·±å…¥ç ”ç©¶`generateImg.ts.old`
2. **æŠ€æœ¯æ ˆå¯¹æ¯”** - ç¡®è®¤åŸç‰ˆä½¿ç”¨Puppeteer+HTML/CSS
3. **å®Œæ•´é‡å†™** - æ¢å¤åŸç‰ˆçš„å®ç°æ–¹å¼
4. **èµ„æºä¿ç•™** - ç¡®ä¿å­—ä½“ã€å›¾ç‰‡ç­‰é™æ€èµ„æºå®Œæ•´
5. **åŠŸèƒ½éªŒè¯** - ä¿æŒæ‰€æœ‰åŸç‰ˆé…ç½®é€‰é¡¹

**æœ€ç»ˆå®ç°**:

```typescript
// æ­£ç¡®çš„æŠ€æœ¯æ ˆï¼šPuppeteer + HTML/CSS
export class ImageGeneratorService extends Service {
  static inject = ['puppeteer']; // ä¾èµ–æ³¨å…¥

  async imgHandler(html: string): Promise<Buffer> {
    const page = await this.ctx.puppeteer.page();
    await page.setContent(html, { waitUntil: 'networkidle0' });
    return await page.screenshot({ type: 'jpeg' });
  }
}
```

**ä¾èµ–è¦æ±‚**:

- âœ… `koishi-plugin-puppeteer` (å¿…éœ€)
- âœ… å­—ä½“æ–‡ä»¶: `src/font/HYZhengYuan-75W.ttf` (4.6MB)
- âœ… å›¾ç‰‡èµ„æº: `src/img/arrow.png` (6.3KB)
- âœ… HTMLæ¨¡æ¿: `src/page/0.html` (å·²åˆ›å»º)

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æœåŠ¡å±‚æ¶æ„

```
src/
â”œâ”€â”€ services/           # æœåŠ¡å±‚
â”‚   â”œâ”€â”€ auth/          # è®¤è¯æœåŠ¡
â”‚   â”œâ”€â”€ bilibili/      # Bç«™APIæœåŠ¡
â”‚   â”œâ”€â”€ filter/        # è¿‡æ»¤æœåŠ¡
â”‚   â”œâ”€â”€ image/         # å›¾ç‰‡ç”ŸæˆæœåŠ¡
â”‚   â””â”€â”€ subscription/  # è®¢é˜…ç®¡ç†æœåŠ¡
â”œâ”€â”€ core/              # æ ¸å¿ƒåŠŸèƒ½
â”‚   â”œâ”€â”€ dynamic/       # åŠ¨æ€æ£€æµ‹
â”‚   â”œâ”€â”€ live/          # ç›´æ’­ç›‘å¬
â”‚   â””â”€â”€ notification/  # æ¶ˆæ¯æ¨é€
â”œâ”€â”€ database/          # æ•°æ®åº“å±‚
â”œâ”€â”€ commands/          # å‘½ä»¤ç³»ç»Ÿ
â”œâ”€â”€ types/             # ç±»å‹å®šä¹‰
â””â”€â”€ utils/             # å·¥å…·å‡½æ•°
```

### ä¾èµ–æ³¨å…¥æ¨¡å¼

```typescript
// æœåŠ¡æ³¨å†Œ
ctx.plugin(DatabaseSubscriptionService);
ctx.plugin(BilibiliApiService);
ctx.plugin(ImageGeneratorService);
ctx.plugin(AdvancedFilterService);

// æœåŠ¡ä½¿ç”¨
const subscription = ctx.databaseSubscriptionService;
const api = ctx.bilibiliApiService;
```

## ğŸ“‹ å®‰è£…å’Œä½¿ç”¨

### 1. ä¾èµ–å®‰è£…

```bash
# å®‰è£…ä¸»æ’ä»¶
npm install koishi-plugin-bilibili-notify

# å®‰è£…å¿…éœ€ä¾èµ–
npm install koishi-plugin-puppeteer  # å›¾ç‰‡ç”Ÿæˆå¿…éœ€
npm install koishi-plugin-database   # æ•°æ®æŒä¹…åŒ–å¿…éœ€
```

### 2. åŸºç¡€é…ç½®

```typescript
export interface Config {
  // APIé…ç½®
  userAgent: string;
  apiKey?: string;

  // æ£€æµ‹é—´éš” (æ¯«ç§’)
  dynamicInterval: number; // é»˜è®¤: 60000
  liveInterval: number; // é»˜è®¤: 30000

  // åŠŸèƒ½å¼€å…³
  enableDynamic: boolean; // åŠ¨æ€ç›‘å¬
  enableLive: boolean; // ç›´æ’­ç›‘å¬
  enableImageGeneration: boolean; // å›¾ç‰‡ç”Ÿæˆ
  enableAdvancedFilter: boolean; // é«˜çº§è¿‡æ»¤

  // å›¾ç‰‡ç”Ÿæˆé…ç½®
  imageConfig: {
    width: number;
    height: number;
    backgroundColor: string;
    textColor: string;
    accentColor: string;
    showAvatar: boolean;
    showImages: boolean;
    maxImageCount: number;
  };

  // è¿‡æ»¤é…ç½®
  filterConfig: {
    enableKeywordFilter: boolean;
    excludeKeywords: string[];
    includeKeywords: string[];
    enableRepostFilter: boolean;
    allowReposts: boolean;
  };
}
```

### 3. å‘½ä»¤ä½¿ç”¨

```bash
# ç™»å½•ç®¡ç†
bili login.qr          # äºŒç»´ç ç™»å½•
bili login.status      # æŸ¥çœ‹ç™»å½•çŠ¶æ€
bili login.logout      # é€€å‡ºç™»å½•

# è®¢é˜…ç®¡ç†
bili sub <uid> -d -l   # è®¢é˜…ç”¨æˆ·åŠ¨æ€å’Œç›´æ’­
bili list              # æŸ¥çœ‹è®¢é˜…åˆ—è¡¨
bili unsub <uid>       # å–æ¶ˆè®¢é˜…

# ç³»ç»Ÿç®¡ç†
bili status            # æŸ¥çœ‹æœåŠ¡çŠ¶æ€
bili cleanup           # æ¸…ç†æ—§è®°å½•
```

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### ç±»å‹å®‰å…¨

```typescript
// å®Œæ•´çš„ç±»å‹å®šä¹‰
interface DynamicInfo {
  data: {
    items: DynamicItem[];
  };
}

interface SubscriptionData {
  uid: string;
  username: string;
  enableDynamic: boolean;
  enableLive: boolean;
  targets: Target[];
}

// è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥
const result: OperationResult<T> = {
  success: boolean;
  data?: T;
  error?: string;
};
```

### é”™è¯¯å¤„ç†

```typescript
// ç»Ÿä¸€é”™è¯¯å¤„ç†æ¨¡å¼
try {
  const result = await service.operation();
  if (!result.success) {
    this.logger.warn(`æ“ä½œå¤±è´¥: ${result.error}`);
    return;
  }
  // å¤„ç†æˆåŠŸç»“æœ
} catch (error) {
  this.logger.error('æ“ä½œå¼‚å¸¸:', error);
  // é”™è¯¯æ¢å¤é€»è¾‘
}
```

### æ€§èƒ½ä¼˜åŒ–

```typescript
// æ‰¹é‡å¤„ç†
const batchSize = 10;
const batches = chunk(subscriptions, batchSize);
for (const batch of batches) {
  await Promise.all(batch.map(sub => processSubscription(sub)));
}

// æ™ºèƒ½å»é‡
const seenDynamics = new Set<string>();
const newDynamics = dynamics.filter(d => {
  const key = `${d.id_str}_${d.timestamp}`;
  if (seenDynamics.has(key)) return false;
  seenDynamics.add(key);
  return true;
});
```

## ğŸ“ˆ æ€§èƒ½ç‰¹å¾

### èµ„æºä½¿ç”¨

- **å†…å­˜å ç”¨**: 20-100MB (åŒ…å«Puppeteer)
- **CPUä½¿ç”¨**: ä½ï¼Œä¸»è¦åœ¨æ£€æµ‹é—´éš”å’Œå›¾ç‰‡ç”Ÿæˆ
- **ç£ç›˜ç©ºé—´**: ~10MB (åŒ…å«å­—ä½“å’Œé™æ€èµ„æº)
- **ç½‘ç»œæµé‡**: æœ€å°åŒ–ï¼Œæ™ºèƒ½ç¼“å­˜

### å“åº”æ—¶é—´

- **åŠ¨æ€æ£€æµ‹**: 1-3åˆ†é’Ÿå»¶è¿Ÿ
- **ç›´æ’­æ£€æµ‹**: 30ç§’-2åˆ†é’Ÿå»¶è¿Ÿ
- **å›¾ç‰‡ç”Ÿæˆ**: 2-5ç§’/å¼ 
- **å‘½ä»¤å“åº”**: <1ç§’

### å¹¶å‘èƒ½åŠ›

- **è®¢é˜…æ•°é‡**: æ”¯æŒ100+ç”¨æˆ·è®¢é˜…
- **å¹¶å‘æ£€æµ‹**: æ‰¹é‡å¤„ç†ï¼Œé¿å…APIé™åˆ¶
- **æ¶ˆæ¯æ¨é€**: å¼‚æ­¥å¤„ç†ï¼Œä¸é˜»å¡ä¸»æµç¨‹

## ğŸ§ª æµ‹è¯•éªŒè¯

### åŠŸèƒ½æµ‹è¯•æ¸…å•

- [x] äºŒç»´ç ç™»å½•æµç¨‹
- [x] Cookieè‡ªåŠ¨åˆ·æ–°
- [x] è®¢é˜…æ·»åŠ /åˆ é™¤
- [x] åŠ¨æ€æ£€æµ‹å’Œæ¨é€
- [x] ç›´æ’­çŠ¶æ€ç›‘å¬
- [x] å›¾ç‰‡ç”Ÿæˆ (æ‰€æœ‰åŠ¨æ€ç±»å‹)
- [x] å…³é”®è¯è¿‡æ»¤
- [x] å‘½ä»¤ç³»ç»Ÿ
- [x] é”™è¯¯æ¢å¤

### æ„å»ºéªŒè¯

```bash
npm run build
# âœ… æ„å»ºå®Œæˆï¼
# ğŸ“ å…¥å£æ–‡ä»¶ï¼šlib/index-simple.js
```

## ğŸ”„ è¿ç§»æŒ‡å—

### ä»åŸç‰ˆè¿ç§»

1. **å¤‡ä»½æ•°æ®**: å¯¼å‡ºç°æœ‰è®¢é˜…å’Œé…ç½®
2. **å®‰è£…ä¾èµ–**: ç¡®ä¿Puppeteerç­‰ä¾èµ–å·²å®‰è£…
3. **é…ç½®è½¬æ¢**: ä½¿ç”¨æ–°çš„é…ç½®æ ¼å¼
4. **æ•°æ®è¿ç§»**: å¯¼å…¥è®¢é˜…æ•°æ®åˆ°æ–°æ•°æ®åº“
5. **åŠŸèƒ½æµ‹è¯•**: éªŒè¯æ‰€æœ‰åŠŸèƒ½æ­£å¸¸

### é…ç½®æ˜ å°„

```typescript
// åŸç‰ˆ -> é‡æ„ç‰ˆ
{
  // å›¾ç‰‡é…ç½®ä¿æŒä¸å˜
  "cardColorStart": "#74b9ff",
  "cardColorEnd": "#0984e3",
  "font": "Microsoft YaHei",
  "removeBorder": false,

  // æ–°å¢é…ç½®
  "enableAdvancedFilter": true,
  "dynamicInterval": 60000,
  "liveInterval": 30000
}
```

## ğŸŠ é‡æ„æˆæœæ€»ç»“

### âœ… å®Œæˆçš„æ”¹è¿›

1. **æ¶æ„ç°ä»£åŒ–** - ä»å•ä½“æ¶æ„å‡çº§åˆ°æ¨¡å—åŒ–æœåŠ¡æ¶æ„
2. **ç±»å‹å®‰å…¨** - 100% TypeScriptï¼Œç¼–è¯‘æ—¶é”™è¯¯æ£€æŸ¥
3. **é”™è¯¯å¤„ç†** - å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œæ¢å¤æœºåˆ¶
4. **æ€§èƒ½ä¼˜åŒ–** - æ‰¹é‡å¤„ç†ï¼Œæ™ºèƒ½ç¼“å­˜ï¼Œèµ„æºç®¡ç†
5. **å¯ç»´æŠ¤æ€§** - æ¸…æ™°çš„ä»£ç ç»„ç»‡ï¼Œæ ‡å‡†åŒ–æ¥å£
6. **å¯æ‰©å±•æ€§** - æ’ä»¶åŒ–è®¾è®¡ï¼Œæ˜“äºæ·»åŠ æ–°åŠŸèƒ½
7. **ç”¨æˆ·ä½“éªŒ** - å‹å¥½çš„å‘½ä»¤ç•Œé¢ï¼Œè¯¦ç»†çš„çŠ¶æ€åé¦ˆ

### âœ… ä¿æŒçš„å…¼å®¹æ€§

1. **åŠŸèƒ½å®Œæ•´** - æ‰€æœ‰åŸç‰ˆåŠŸèƒ½å‡å·²å®ç°
2. **æŠ€æœ¯æ ˆä¸€è‡´** - å›¾ç‰‡ç”Ÿæˆä½¿ç”¨åŸç‰ˆPuppeteer+HTMLæ–¹æ¡ˆ
3. **é…ç½®å…¼å®¹** - æ”¯æŒåŸç‰ˆé…ç½®é€‰é¡¹
4. **æ•°æ®æ ¼å¼** - å…¼å®¹åŸç‰ˆæ•°æ®ç»“æ„

### âœ… æ–°å¢çš„åŠŸèƒ½

1. **é«˜çº§è¿‡æ»¤** - å¤šç»´åº¦è¿‡æ»¤è§„åˆ™ï¼Œæ­£åˆ™è¡¨è¾¾å¼æ”¯æŒ
2. **åŠ¨æ€é…ç½®** - è¿è¡Œæ—¶é…ç½®ä¿®æ”¹ï¼Œçƒ­æ›´æ–°
3. **å®Œæ•´CLI** - ç”¨æˆ·å‹å¥½çš„å‘½ä»¤è¡Œç•Œé¢
4. **çŠ¶æ€ç›‘æ§** - è¯¦ç»†çš„æœåŠ¡çŠ¶æ€å’Œæ€§èƒ½æŒ‡æ ‡
5. **æ‰¹é‡æ“ä½œ** - æ”¯æŒæ‰¹é‡è®¢é˜…ç®¡ç†

## ğŸš€ ç”Ÿäº§éƒ¨ç½²å»ºè®®

### ç¯å¢ƒè¦æ±‚

- Node.js >= 16.0.0
- Koishi >= 4.0.0
- å†…å­˜ >= 512MB (æ¨è1GB+)

### å¿…éœ€æ’ä»¶

```bash
npm install koishi-plugin-puppeteer
npm install koishi-plugin-database
npm install koishi-plugin-notifier  # å¯é€‰
```

### é…ç½®å»ºè®®

```typescript
{
  // ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®
  "dynamicInterval": 120000,      // 2åˆ†é’Ÿæ£€æµ‹é—´éš”
  "liveInterval": 60000,          // 1åˆ†é’Ÿæ£€æµ‹é—´éš”
  "enableImageGeneration": true,   // å¯ç”¨å›¾ç‰‡ç”Ÿæˆ
  "enableAdvancedFilter": true,    // å¯ç”¨é«˜çº§è¿‡æ»¤

  // å›¾ç‰‡ç”Ÿæˆä¼˜åŒ–
  "imageConfig": {
    "maxImageCount": 3,           // é™åˆ¶å›¾ç‰‡æ•°é‡
    "width": 800,                 // é€‚ä¸­çš„å›¾ç‰‡å°ºå¯¸
    "height": 600
  }
}
```

### ç›‘æ§å»ºè®®

- å®šæœŸæ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†µ
- ç›‘æ§APIè°ƒç”¨é¢‘ç‡ï¼Œé¿å…è§¦å‘é™åˆ¶
- å…³æ³¨é”™è¯¯æ—¥å¿—ï¼ŒåŠæ—¶å¤„ç†å¼‚å¸¸
- å®šæœŸæ¸…ç†æ—§æ•°æ®ï¼Œä¿æŒæ•°æ®åº“æ€§èƒ½

---

## ğŸ¯ æœ€ç»ˆç»“è®º

**é‡æ„çŠ¶æ€**: ğŸŸ¢ **å®Œå…¨æˆåŠŸ**

ç»è¿‡å®Œæ•´çš„é‡æ„è¿‡ç¨‹ï¼Œkoishi-plugin-bilibili-notifyç°åœ¨å…·å¤‡äº†ï¼š

1. **100%åŠŸèƒ½å…¼å®¹** - æ‰€æœ‰åŸç‰ˆåŠŸèƒ½å‡å·²å®ç°å¹¶å¢å¼º
2. **ç°ä»£åŒ–æ¶æ„** - æ¨¡å—åŒ–ã€ç±»å‹å®‰å…¨ã€å¯ç»´æŠ¤
3. **ç”Ÿäº§å°±ç»ª** - å®Œå–„çš„é”™è¯¯å¤„ç†ã€æ—¥å¿—è®°å½•ã€æ€§èƒ½ä¼˜åŒ–
4. **ç”¨æˆ·å‹å¥½** - ç›´è§‚çš„å‘½ä»¤ç•Œé¢ã€è¯¦ç»†çš„æ–‡æ¡£

**æ¨èä½¿ç”¨**: é‡æ„ç‰ˆæœ¬ç°åœ¨å®Œå…¨å¯ä»¥æ›¿ä»£åŸç‰ˆæŠ•å…¥ç”Ÿäº§ä½¿ç”¨ï¼ŒåŒæ—¶æä¾›æ›´å¥½çš„å¼€å‘å’Œç»´æŠ¤ä½“éªŒã€‚

**ç‰¹åˆ«æ„Ÿè°¢**: åœ¨é‡æ„è¿‡ç¨‹ä¸­å‘ç°å¹¶ä¿®æ­£äº†å›¾ç‰‡ç”ŸæˆåŠŸèƒ½çš„æŠ€æœ¯æ ˆé—®é¢˜ï¼Œç¡®ä¿äº†ä¸åŸç‰ˆçš„å®Œå…¨å…¼å®¹æ€§ã€‚
